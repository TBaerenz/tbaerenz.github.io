<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informatik Tutor AI (Llama 3.2)</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --chat-bg: #ffffff;
            --user-msg-bg: #007bff;
            --user-text: #ffffff;
            --ai-msg-bg: #e9ecef;
            --ai-text: #333333;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 { color: #333; margin-bottom: 5px; }
        p.subtitle { color: #666; margin-top: 0; margin-bottom: 20px; font-size: 0.9rem; }

        /* Container für den Chat */
        #chat-container {
            width: 100%;
            max-width: 900px;
            flex-grow: 1;
            background: var(--chat-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Verlauf */
        #chat-history {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Nachrichten Styles */
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }

        .user-msg {
            align-self: flex-end;
            background-color: var(--user-msg-bg);
            color: var(--user-text);
            border-bottom-right-radius: 2px;
        }

        .ai-msg {
            align-self: flex-start;
            background-color: var(--ai-msg-bg);
            color: var(--ai-text);
            border-bottom-left-radius: 2px;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Code-Blöcke in der AI Antwort etwas hervorheben */
        .ai-msg pre {
            background: #dcdcdc;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        /* Eingabebereich */
        #input-area {
            display: flex;
            padding: 20px;
            background: #fff;
            border-top: 1px solid #ddd;
        }

        textarea {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            padding: 12px;
            font-size: 1rem;
            resize: none;
            height: 50px;
            font-family: inherit;
        }
        
        textarea:focus { outline: 2px solid var(--user-msg-bg); }

        button {
            margin-left: 10px;
            padding: 0 20px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--user-msg-bg);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Status Overlay (für den Ladevorgang) */
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            padding: 20px;
        }
        
        #progress-text { margin-top: 15px; color: #555; font-weight: bold;}
        
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <h1>Informatik Tutor AI</h1>
    <p class="subtitle">Lokales Llama-3.2 Modell im Browser (Sokratische Methode)</p>

    <div id="chat-container">
        <!-- Chat Verlauf -->
        <div id="chat-history">
            <div class="message ai-msg">
                Hallo! Ich bin dein Informatik-Tutor. Ich helfe dir, Fehler zu finden und Konzepte zu verstehen, aber ich werde dir nicht einfach die Lösung verraten. Was ist deine Aufgabe?
            </div>
        </div>

        <!-- Eingabe -->
        <div id="input-area">
            <textarea id="user-input" placeholder="Kopiere deinen Code hier rein oder stelle eine Frage..."></textarea>
            <button id="btn-send" onclick="sendMessage()" disabled>Senden</button>
        </div>
    </div>

    <!-- Overlay zum Laden des Modells -->
    <div id="loading-overlay">
        <h2>KI-Modell wird initialisiert</h2>
        <p>Da dies eine lokale KI ist, müssen einmalig ca. <strong>2.5 GB</strong> Daten heruntergeladen werden.</p>
        <p>Bitte nicht das Fenster schließen.</p>
        <button id="btn-load" onclick="initChat()">Modell jetzt laden</button>
        <div id="progress-text"></div>
    </div>

    <!-- Script -->
    <script type="module">
        import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

        // Konfiguration: Llama-3.2-3B ist ein guter Kompromiss aus Logik-Verständnis und Größe.
        const SELECTED_MODEL = "Llama-3.2-3B-Instruct-q4f16_1-MLC";

        // DER SYSTEM PROMPT: Hier definieren wir die "Persönlichkeit" des Tutors.
        const SYSTEM_PROMPT = `
        Du bist ein geduldiger und hilfreicher Informatik-Tutor für Schüler.
        Deine pädagogische Strategie ist die Sokratische Methode.

        REGELN:
        1. Gib NIEMALS den vollständig korrigierten Code als Lösung aus.
        2. Wenn der User Code mit Fehlern sendet, analysiere ihn und gib Hinweise, wo der Fehler liegt (z.B. "Schau dir Zeile 5 nochmal an" oder "Du hast eine Klammer vergessen").
        3. Erkläre Konzepte verständlich auf Deutsch.
        4. Wenn der User explizit nach der Lösung fragt, lehne höflich ab und biete stattdessen Pseudocode oder einen strategischen Tipp an.
        5. Formatiere Code-Beispiele (nur kurze Snippets!) sauber.
        
        Ziel ist, dass der Schüler den Fehler selbst behebt und dabei lernt.
        `;

        let engine;
        let messages = [
            { role: "system", content: SYSTEM_PROMPT }
        ];

        // UI Elemente
        const btnLoad = document.getElementById('btn-load');
        const btnSend = document.getElementById('btn-send');
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        const overlay = document.getElementById('loading-overlay');
        const progressText = document.getElementById('progress-text');

        // Funktion: Initialisierung der Engine
        window.initChat = async () => {
            btnLoad.style.display = 'none'; // Button verstecken
            progressText.innerText = "Verbindung wird aufgebaut...";

            try {
                // Engine erstellen mit Callback für Ladebalken
                engine = await CreateMLCEngine(
                    SELECTED_MODEL,
                    { 
                        initProgressCallback: (report) => {
                            progressText.innerText = report.text;
                        }
                    }
                );

                // Wenn fertig: Overlay ausblenden
                overlay.classList.add('hidden');
                btnSend.disabled = false;
                userInput.focus();

            } catch (err) {
                progressText.innerText = "Fehler beim Laden: " + err.message;
                progressText.style.color = "red";
                btnLoad.style.display = 'inline-block';
            }
        };

        // Funktion: Nachricht senden
        window.sendMessage = async () => {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. User Nachricht anzeigen
            appendMessage("Du", text, "user-msg");
            messages.push({ role: "user", content: text });
            
            userInput.value = "";
            btnSend.disabled = true; // Button sperren während Antwort

            // 2. Platzhalter für AI Antwort erstellen
            const aiMsgDiv = appendMessage("Tutor", "...", "ai-msg");

            try {
                // 3. API Call (Streaming)
                const chunks = await engine.chat.completions.create({
                    messages: messages,
                    stream: true,
                    temperature: 0.6 // Etwas kreativer, aber nicht zu wild
                });

                let fullResponse = "";
                
                for await (const chunk of chunks) {
                    const content = chunk.choices[0]?.delta?.content || "";
                    fullResponse += content;
                    
                    // Live-Update des Textes (einfaches Rendering)
                    // Für echtes Syntax-Highlighting bräuchte man eine ext. Library wie 'marked',
                    // aber für diese einfache Version reicht pre-wrap Styling.
                    aiMsgDiv.innerText = fullResponse; 
                }

                // Nachricht zum Verlauf hinzufügen
                messages.push({ role: "assistant", content: fullResponse });

            } catch (err) {
                aiMsgDiv.innerText = "Fehler: " + err.message;
            } finally {
                btnSend.disabled = false;
                // Scrollen zum Ende
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        };

        // Hilfsfunktion: Element ins DOM einfügen
        function appendMessage(sender, text, className) {
            const div = document.createElement('div');
            div.className = `message ${className}`;
            div.innerText = text; // textContent verhindert XSS, aber formatiert kein HTML
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return div;
        }

        // Enter-Taste im Textfeld sendet Nachricht (außer Shift+Enter)
        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                if (!btnSend.disabled) sendMessage();
            }
        });
    </script>
</body>
</html>
